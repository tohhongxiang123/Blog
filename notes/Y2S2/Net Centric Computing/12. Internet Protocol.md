# Internet Protocol

Network Taxonomy
- Switched networks
    - Circuit switched networks, such as telephone networks
        - A dedicated circuit guarantees full bandwidth for the sender and the receiver
    - Packet-switched networks
        - Datagram networks, such as IP networks
            - Transmission begins without establishing a path first. 
            - Data is split into packets, and then each packet finds their own route from the sender to the receiver. Data does not have to arrive in sequence, but will be reassembled into sequence when they arrive at their destinations
            - Sender needs to append a header containing the destination address so that the intermediate packet-switched nodes know how to send it to the destination
            - Packet-switched nodes are shared with others for transmission (efficient usage of resources)
        - Virtual-circuit networks, such as X.25
            - Before sending the packets, the network will find the "best" path for the packets. Once a path is found, all the packets will be sent in order, following the same path to the destination

We will be focusing on datagram networks, because the Internet Protocol uses datagram networks

# Characteristics of Internet Protocol

- 2 basic protocol functions
    - Addressing
    - Fragmentation
- Provides a connectionless unreliable best-effort (datagram) service
    - Connectionless: Each packet is handled independently, no flow control
    - Unreliable: No error control
    - Best-effort: No throughput guarantee, no delay guarantee, no Quality of Service (QoS) guarantee

The IP header, specifically IPv4 is designed as follows (RFC 791)
- Header: 20 - 60 bytes
    - VER: 4 bits, IP version field, set to 4 for IPv4 
    - HLEN: 4 bits: Internet header length, the number of 32-bit words that make up the header field. The minimum available number is 5 (32 * 5 / 8 = 20), as the first 20 bytes are mandatory
    - Service: 8 bits: Type of service (for differentiated services), such as voice-over IP
    - Total length: 16 bits: Total size of datagram, including header and data parts. Max size is $2^16 = 65536$ bytes
    - Identification: 16 bits: Used to indicate a group of fragments if the datagram is fragmented
    - Flags: 3 bits: Different combinations of the flags control fragmentation and indicate fragmented datagrams
    - Fragmentation offset: 13 bits: Offset of a fragmented packet
    - Time to live: 8 bits: Number of hops a packet lives. Each router decrements this field. If 0, the packet is discarded. Used to eliminate looping packets
    - Protocol: 8 bits: Protocol used in the data part, such as 0x01 for ICMP, 0x06 for TCP, 0x11 for UDP
    - Header checksum: 16 bits: Checksum for error detection, covering only the header field
    - Source IP address: 32 bits
    - Destination IP address: 32 bits
- Data: Header + Data is 20 - 65535 bytes

# IP Address Notation

```
10000000 00001011 00000011 00011111
128 . 11 . 3 . 31
```

## Classes of IP address

| Class | Leading bits | Size of network number bit field | Size of rest bit field | Number of networks | Addresses per network | Start address | End address     |
| ----- | ------------ | -------------------------------- | ---------------------- | ------------------ | --------------------- | ------------- | --------------- |
| A     | 0            | 8                                | 24                     | 2^7                | 2^24                  | 0.0.0.0       | 127.255.255.255 |
| B     | 10           | 16                               | 16                     | 2^14               | 2^16                  | 128.0.0.0     | 191.255.255.255 |
| C     | 110          | 24                               | 8                      | 2^21               | 2^8                   | 192.0.0.0     | 223.255.255.255 |


## IPv4 Address: Special Use (RFC 5735)

An address assigned to the host/router's interface
- An interface is a connection between the host/router and the physical link
- A network (from the IP address perspective)
    - Device interfaces with same network id of IP address
    - Can physically reach each other without intermediate router

- Network and/or host id - All '0's (can only be used as a source address; e.g. during startup to get own IP in DHCP)
    - 0.0.0.0 : the host on this network
    - 155.69.0.0 : The network/subnet ID
- Network and/or host id - All '1's: (can only be used as a destination address)
    - 255.255.255.255 : limited broadcast within this network (ARP)
    - 155.69.255.255 : directed broadcast on 155.69.xx.xx netweork
- Loopback address (127.x.y.z)
    - Internal loopback to the same host
    - Useful for self-testing of network software
    - E.g. localhost: 127.0.0.1

## Subnetting (RFC 950)

Subnetting is partitioning a single large network into smaller networks called subnets
- Subnetting is used for easier management
- Subnets make networks more efficient, as network traffic can travel a shorter distance without passing through unnecessary routers to reach its destination

Subnetting is done by adding another level of hierarchy to the IP address structure
- Initially, we had network prefix, host number
- Now, we have network prefix, subnet number, and host number
    - The network prefix + subnet number is the "extended network prefix" for a subnet

Note that
- Subnets are only visible within the organisation
- Hence, organisation is free to decide the number of bits for subnet and host numbers
- Externally, the organisation network is still viewed as a single, large network

### Subnet Masks

- To indicate the length of the extended network prefix, we use a subnet mask w.x.y.z (bits corresponding to extended network prefix are set to 1's, otherwise set to 0)
- For example, 
    - Consider a network address 166.113.0.0 with 5 subnet ID bits
    - 166 = 1010 0110, hence this is a class B network
    - We know that the first 16 bits of the network address is the network identifier, while 5 more bits are the subnet ID bits
    - Hence, the subnet mask is 11111111 11111111 11111000 00000000 (255.255.248.0)
    - We usually use a "slash notation" (a.b.c.d/x) where x indicates the number of bits for the extended network prefix
    - Consider the subnet address 166.113.8.0/21
        - We know our network prefix has 21 bits, hence we use the subnet mask 255.255.248.0
        - Doing a logical AND between the subnet address and subnet mask, we get the network ID (166.113.8.0)
        - The subnet addresses range from 166.113.8.0 - 166.113.15.255
- Subnet masks are usually used during the setting up of communication, to determine if the source and destination are in the same subnet

### Subnet Broadcasting

- A subnet broadcast address is when the host address is set to all 1s
    - E.g. consider a class B address 166.113.0.0/21
    - This has a subnet mask of 255.255.248.0
    - Then 166.113.15.255 refers to a broadcast to the subnet 166.113.8.0/21

```
10100110 1110001 00001111 00000000
11111111 1111111 11111000 00000000

10100110 1110001 00001000 00000000 (Masked)
10100110 1110001 00001111 11111111 (166.113.15.255, broadcast)
```

- All subnet broadcast (set subnet and host address to all 1's)
    - Note that the first 16 bits is the network address
    - The next 5 bits refers to the subnet
    - The remaining 11 bits refers to the host
    - 166.113.255.255 means broadcast to all hosts in all subnets under 166.113

# IPv4 Address Exhaustion

Classful IP addressing problems:
- Inefficient use of address space
    - $2^{14}$ organisations own 25% of total IP addresses, with each class B supporting up to 655354 hosts. However, does each organisation require that many hosts?
    - $2^{21}$ organisations own 12.5% of total IP addresses. But each class C address supports only up to 254 hosts, too small
    - 126 organisations own 50% of total IP addresses, very wasteful

We can see that 32bit IP addresses is too wasteful for modern day usage. IP addresses exhausted on 3 Feb 2011.

## Solution to IPv4 Address Exhaustion

- Classless interdomain routing (short-term solution)
    - Reduces wastage in address allocation
    - Organisations will be given sufficient, but not excessive address space
- Network Address Translation (NAT) using private IP address (will ease, but not solve the problem)
    - A single machine (usually a router) with an IP address representing many computers behind it. IP address requires translation
- IPv6, 128-bit space (long-term solution)
    - Large enough to install several billion computers on every square meter of the earth's surface
    - However, people have no motivation to upgrade from IPv4 to IPv6

### Classless Interdomain Routing

- Abandon classful addressing
- Key concept: Length of network ID (prefix) can be of any length
- Consequence: Add a network mask w.x.y.z (similar to subnet masking)

The format of a CIDR address:
- Network id (n-bits), host id (32 - n bits)
- W.X.Y.Z/n

With CIDR, we can also extend it to subnetting, having variable length subnet masks
- 116.113.0.0/20
- 116.113.248.0/21
- Note that the idea of subnet broadcasting is now obsolete. Therefore, subnet numbers including all 0's and all 1's can now be used

#### Router to Router Link (subnet)

- An IP address needs to be assigned to each active interface of a router
- To optimise the use of IP addresses, we usually assign /30 to the link, e.g. 172.16.31.0/30

### Network Address Translation

- (RFC 1918) Private IP address for private internet
    - 10.0.0.0/8 (10.0.0.0 - 10.255.255.255)
    - 172.16.0.0/12 (172.16.0.0 - 172.31.255.255)
- Private IP addresses will not be forwarded to the internet
- Hence, different private networks can reuse the same IP address
- By using a NAT-enabled router, only 1 IP address is required from the ISP to support the whole private network to connect to the internet
    - A NAT translation table is provided, which converts a public IP/port to a private IP/port

Consider the following NAT translation table

| Public IP/port   | Private IP/port |
| ---------------- | --------------- |
| 138.76.39.7:5001 | 10.0.0.1:3345   |

- From within the network, a computer with the private IP address 10.0.0.1:3345 wants to send data to outside the network, 128.119.40.186:80
- The router will translate the private IP address into the public IP address. On the outside, everyone will see the source as 138.76.39.7:5001, rather than the private IP address
- When the router receives data with destination to 138.76.39.7:5001, the router will translate this to the private IP address 10.0.0.1:3345, and then send the data to the correct recipient

### IPv6

- Standardised since 1005 (RFC 1883, 2460)
- Main enhancement in IPv6
    - Expanded address space: 128-bit IPv6 address
    - Colon hexadecimal notation
        - FDEC:BA98:7654:3210:ADBF:BBFF:2922:FFFF
    - Abbreviated notation
        - within each 16-bit value, 0000 can be written as 0
        - Consecutive groups of 0 are replaced by ::
        - FDEC:0:0:0:0:BBFF:0:FFFF -> FDEC::BBFF:0:FFFF
    - Simplification of header: Faster processing
        - Note that IPv4 and IPv6 are incompatible. Only the first 4 bits (ver-field) in IPv4 and IPv6 headers are the same to distinguish them

#### Transition from IPv4 to IPv6

- Not all routers can be upgraded simultaneously. How will networks operate simultaneously with IPv4 and IPv6?
    - Transition strategies:
        - Dual stack
        - Tunnelling

Contineu from slide 45


# Resources
- https://www.cloudflare.com/learning/network-layer/what-is-a-subnet/