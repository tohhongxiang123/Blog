# Internet Protocol

Network Taxonomy

-   Switched networks
    -   Circuit switched networks, such as telephone networks
        -   A dedicated circuit guarantees full bandwidth for the sender and the receiver
    -   Packet-switched networks
        -   Datagram networks, such as IP networks
            -   Transmission begins without establishing a path first.
            -   Data is split into packets, and then each packet finds their own route from the sender to the receiver. Data does not have to arrive in sequence, but will be reassembled into sequence when they arrive at their destinations
            -   Sender needs to append a header containing the destination address so that the intermediate packet-switched nodes know how to send it to the destination
            -   Packet-switched nodes are shared with others for transmission (efficient usage of resources)
        -   Virtual-circuit networks, such as X.25
            -   Before sending the packets, the network will find the "best" path for the packets. Once a path is found, all the packets will be sent in order, following the same path to the destination

We will be focusing on datagram networks, because the Internet Protocol uses datagram networks

# Characteristics of Internet Protocol

-   2 basic protocol functions
    -   Addressing
    -   Fragmentation
-   Provides a connectionless unreliable best-effort (datagram) service
    -   Connectionless: Each packet is handled independently, no flow control
    -   Unreliable: No error control
    -   Best-effort: No throughput guarantee, no delay guarantee, no Quality of Service (QoS) guarantee

The IP header, specifically IPv4 is designed as follows (RFC 791)

-   Header: 20 - 60 bytes
    -   VER: 4 bits, IP version field, set to 4 for IPv4
    -   HLEN: 4 bits: Internet header length, the number of 32-bit words that make up the header field. The minimum available number is 5 (32 \* 5 / 8 = 20), as the first 20 bytes are mandatory
    -   Service: 8 bits: Type of service (for differentiated services), such as voice-over IP
    -   Total length: 16 bits: Total size of datagram, including header and data parts. Max size is $2^16 = 65536$ bytes
    -   Identification: 16 bits: Used to indicate a group of fragments if the datagram is fragmented
    -   Flags: 3 bits: Different combinations of the flags control fragmentation and indicate fragmented datagrams
    -   Fragmentation offset: 13 bits: Offset of a fragmented packet
    -   Time to live: 8 bits: Number of hops a packet lives. Each router decrements this field. If 0, the packet is discarded. Used to eliminate looping packets
    -   Protocol: 8 bits: Protocol used in the data part, such as 0x01 for ICMP, 0x06 for TCP, 0x11 for UDP
    -   Header checksum: 16 bits: Checksum for error detection, covering only the header field
    -   Source IP address: 32 bits
    -   Destination IP address: 32 bits
-   Data: Header + Data is 20 - 65535 bytes

# IP Address Notation

```
10000000 00001011 00000011 00011111
128 . 11 . 3 . 31
```

## Classes of IP address

| Class | Leading bits | Size of network number bit field | Size of rest bit field | Number of networks | Addresses per network | Start address | End address     |
| ----- | ------------ | -------------------------------- | ---------------------- | ------------------ | --------------------- | ------------- | --------------- |
| A     | 0            | 8                                | 24                     | 2^7                | 2^24                  | 0.0.0.0       | 127.255.255.255 |
| B     | 10           | 16                               | 16                     | 2^14               | 2^16                  | 128.0.0.0     | 191.255.255.255 |
| C     | 110          | 24                               | 8                      | 2^21               | 2^8                   | 192.0.0.0     | 223.255.255.255 |

## IPv4 Address: Special Use (RFC 5735)

An address assigned to the host/router's interface

-   An interface is a connection between the host/router and the physical link
-   A network (from the IP address perspective)

    -   Device interfaces with same network id of IP address
    -   Can physically reach each other without intermediate router

-   Network and/or host id - All '0's (can only be used as a source address; e.g. during startup to get own IP in DHCP)
    -   0.0.0.0 : the host on this network
    -   155.69.0.0 : The network/subnet ID
-   Network and/or host id - All '1's: (can only be used as a destination address)
    -   255.255.255.255 : limited broadcast within this network (ARP)
    -   155.69.255.255 : directed broadcast on 155.69.xx.xx netweork
-   Loopback address (127.x.y.z)
    -   Internal loopback to the same host
    -   Useful for self-testing of network software
    -   E.g. localhost: 127.0.0.1

## Subnetting (RFC 950)

Subnetting is partitioning a single large network into smaller networks called subnets

-   Subnetting is used for easier management
-   Subnets make networks more efficient, as network traffic can travel a shorter distance without passing through unnecessary routers to reach its destination

Subnetting is done by adding another level of hierarchy to the IP address structure

-   Initially, we had network prefix, host number
-   Now, we have network prefix, subnet number, and host number
    -   The network prefix + subnet number is the "extended network prefix" for a subnet

Note that

-   Subnets are only visible within the organisation
-   Hence, organisation is free to decide the number of bits for subnet and host numbers
-   Externally, the organisation network is still viewed as a single, large network

### Subnet Masks

-   To indicate the length of the extended network prefix, we use a subnet mask w.x.y.z (bits corresponding to extended network prefix are set to 1's, otherwise set to 0)
-   For example,
    -   Consider a network address 166.113.0.0 with 5 subnet ID bits
    -   166 = 1010 0110, hence this is a class B network
    -   We know that the first 16 bits of the network address is the network identifier, while 5 more bits are the subnet ID bits
    -   Hence, the subnet mask is 11111111 11111111 11111000 00000000 (255.255.248.0)
    -   We usually use a "slash notation" (a.b.c.d/x) where x indicates the number of bits for the extended network prefix
    -   Consider the subnet address 166.113.8.0/21
        -   We know our network prefix has 21 bits, hence we use the subnet mask 255.255.248.0
        -   Doing a logical AND between the subnet address and subnet mask, we get the network ID (166.113.8.0)
        -   The subnet addresses range from 166.113.8.0 - 166.113.15.255
-   Subnet masks are usually used during the setting up of communication, to determine if the source and destination are in the same subnet

### Subnet Broadcasting

-   A subnet broadcast address is when the host address is set to all 1s
    -   E.g. consider a class B address 166.113.0.0/21
    -   This has a subnet mask of 255.255.248.0
    -   Then 166.113.15.255 refers to a broadcast to the subnet 166.113.8.0/21

```
10100110 1110001 00001111 00000000
11111111 1111111 11111000 00000000

10100110 1110001 00001000 00000000 (Masked)
10100110 1110001 00001111 11111111 (166.113.15.255, broadcast)
```

-   All subnet broadcast (set subnet and host address to all 1's)
    -   Note that the first 16 bits is the network address
    -   The next 5 bits refers to the subnet
    -   The remaining 11 bits refers to the host
    -   166.113.255.255 means broadcast to all hosts in all subnets under 166.113

# IPv4 Address Exhaustion

Classful IP addressing problems:

-   Inefficient use of address space
    -   $2^{14}$ organisations own 25% of total IP addresses, with each class B supporting up to 655354 hosts. However, does each organisation require that many hosts?
    -   $2^{21}$ organisations own 12.5% of total IP addresses. But each class C address supports only up to 254 hosts, too small
    -   126 organisations own 50% of total IP addresses, very wasteful

We can see that 32bit IP addresses is too wasteful for modern day usage. IP addresses exhausted on 3 Feb 2011.

## Solution to IPv4 Address Exhaustion

-   Classless interdomain routing (short-term solution)
    -   Reduces wastage in address allocation
    -   Organisations will be given sufficient, but not excessive address space
-   Network Address Translation (NAT) using private IP address (will ease, but not solve the problem)
    -   A single machine (usually a router) with an IP address representing many computers behind it. IP address requires translation
-   IPv6, 128-bit space (long-term solution)
    -   Large enough to install several billion computers on every square meter of the earth's surface
    -   However, people have no motivation to upgrade from IPv4 to IPv6

### Classless Interdomain Routing

-   Abandon classful addressing
-   Key concept: Length of network ID (prefix) can be of any length
-   Consequence: Add a network mask w.x.y.z (similar to subnet masking)

The format of a CIDR address:

-   Network id (n-bits), host id (32 - n bits)
-   W.X.Y.Z/n

With CIDR, we can also extend it to subnetting, having variable length subnet masks

-   116.113.0.0/20
-   116.113.248.0/21
-   Note that the idea of subnet broadcasting is now obsolete. Therefore, subnet numbers including all 0's and all 1's can now be used

#### Router to Router Link (subnet)

-   An IP address needs to be assigned to each active interface of a router
-   To optimise the use of IP addresses, we usually assign /30 to the link, e.g. 172.16.31.0/30

### Network Address Translation

-   (RFC 1918) Private IP address for private internet
    -   10.0.0.0/8 (10.0.0.0 - 10.255.255.255)
    -   172.16.0.0/12 (172.16.0.0 - 172.31.255.255)
-   Private IP addresses will not be forwarded to the internet
-   Hence, different private networks can reuse the same IP address
-   By using a NAT-enabled router, only 1 IP address is required from the ISP to support the whole private network to connect to the internet
    -   A NAT translation table is provided, which converts a public IP/port to a private IP/port

Consider the following NAT translation table

| Public IP/port   | Private IP/port |
| ---------------- | --------------- |
| 138.76.39.7:5001 | 10.0.0.1:3345   |

-   From within the network, a computer with the private IP address 10.0.0.1:3345 wants to send data to outside the network, 128.119.40.186:80
-   The router will translate the private IP address into the public IP address. On the outside, everyone will see the source as 138.76.39.7:5001, rather than the private IP address
-   When the router receives data with destination to 138.76.39.7:5001, the router will translate this to the private IP address 10.0.0.1:3345, and then send the data to the correct recipient

### IPv6

-   Standardised since 1005 (RFC 1883, 2460)
-   Main enhancement in IPv6
    -   Expanded address space: 128-bit IPv6 address
    -   Colon hexadecimal notation
        -   FDEC:BA98:7654:3210:ADBF:BBFF:2922:FFFF
    -   Abbreviated notation
        -   within each 16-bit value, 0000 can be written as 0
        -   Consecutive groups of 0 are replaced by ::
        -   FDEC:0:0:0:0:BBFF:0:FFFF -> FDEC::BBFF:0:FFFF
    -   Simplification of header: Faster processing
        -   Note that IPv4 and IPv6 are incompatible. Only the first 4 bits (ver-field) in IPv4 and IPv6 headers are the same to distinguish them

#### Transition from IPv4 to IPv6

-   Not all routers can be upgraded simultaneously. How will networks operate simultaneously with IPv4 and IPv6?
    -   Transition strategies:
        -   Dual stack
        -   Tunnelling

# IP Fragmentation and Reassembly

-   Different networks have different MTU (Maximum transfer unit). IP packet size (IP header + data) in each network must be less that or equal to the MTU of that network

## IPv4 Header: Fragmentation Fields

Fragmentation fields consists of 3 different fields:

-   Identification (16 bits): For reassembly purposes, all fragments of a datagram contain the same identification value
-   Flags (3 bits)
    -   Don't fragment (DF): If DF flag is set, the datagram is not fragmented
    -   More fragments (MF): This flag is set to 1 except for the last fragment
-   Fragment offset (13 bits): Tells where in the current datagram this fragment belongs. All fragments except the last one must be a multiple of 8 bytes, the basic fragment unit

# IP Routing

Typically, a host will not know how to send packets to destinations outside its own network. Hence, it is configured with a default gateway (router) to assist in the forwarding

## Routing Process

-   Routing table consists of the following information
    -   Network address: Destination network address
    -   Cost: Arbitrary cost, number of hops
    -   Next hop: Who to pass to next

| Network address | Cost | Next hop           |
| --------------- | ---- | ------------------ |
| 155.69.0.0      | 1    | Directly connected |
| 122.0.0.0       | 1    | Directly connected |
| 194.8.9.0       | 7    | 122.5.6.1          |

1. Extract destination IP address, and compute destination network address
2. Look-up next hop

    - IF
        - Destination IP network = directly connected, then send on the specified interface
    - ELSE IF
        - Destination IP address appears as host specific route THEN route as specified
    - ELSE IF
        - Destination Network address is in the routing table then send the specified IP address through the specified interface
    - ELSE
        - Send packet through DEFAULT route
            - A default route is usually provided that points to the ISP router

    Combining routing and fragmentation

    - At source host, IP encapsulates upper layer data into packet
    - Then, determine the route and the MTU, and fragment if required

3. At each router, IP determines the next route and MTU, and further fragments packets if necessary. However, if DF flag is set, then it is simply discarded
4. Finally, at destination host, IP reassembles packets (if fragmented) before returning data back to upper layers

## IP Over Ethernet

-   How does a packet go from source to destination when only IP addresses are known, but ethernet requires MAC addresses?

### Address Resolution Protocol (RFC 826)

-   ARP Request
    -   A network broadcasts an ARP request to all stations on the network: "What is the MAC address of router 128.143.137.1?"
    -   Router 128.143.137.1 responds with an ARP reply which contains its MAC address: "The MAC address of router 128.143.137.1 is 00:e0:f9:23:a8:20"

ARP Packet - Target IP address

Cases

1. A host has a packet to send to a host on the same network
2. A host has a packet to send to a host on another network
3. A router has a packet to send to a host on another network
4. A router has a packet to send to a host on the same network

-   The ARP packet is sent directly over the ethernet frame

E.g.

-   ARP Request from Argon(Client):

    -   Source hardware address: 00:a0:24:71:e4:44
    -   Source protocol address: 128.143.137.144
    -   Target hardware address: 00:00:00:00:00:00
    -   Target protocol address: 128.143.137.1

-   ARP Reply from Router137:
    -   Source hardware address: 00:e0:f9:23:a8:20
    -   Source protocol address: 128.143.137.1
    -   Target hardware address: 00:a0:24:71:e4:44
    -   Target protocol address: 128.143.137.144

### ARP Cache

-   Since sending ARP request/reply for each IP datagram is inefficient, hosts maintain a cache (ARP Cache) of current entries. Typically, entries are configured to expire after 2 to 20 minutes

# IP Related Protocols

-   ICMP
-   PING
-   TRACERT

## ICMP (Internet Control Message Protocol) (RFC792 and 1122)

-   ICMP is a supporting protocol in the Internet protocol suite. It is used by network devices, including routers, to send error messages and operational information indicating, for example, that a requested service is not available or that host or router could not be reached

What happens if a source IP packet cannot be delivered to its destination?

-   Although IP does not perform error control, it must still report errors
-   Otherwise, the source TCP (transport layer) may retransmit all data causing IP to send the same packets again, that can never reach the destination
-   Hence, ICMP is created for routers/hosts to report errors to the source. It is the responsibility of the host to handle the reported problems

How does ICMP work?

-   An ICMP packet is sent over IP packet, which in turn is sent over the data link layer protocol, e.g. Ethernet
-   Note that, althought ICMP is over IP, it is considered a layer-3 protocol

Generally, there are 2 types of ICMP messages

1. Error
    - Destination unreachable
    - Source quench
    - Time exceeded
    - Parameter problem
    - Redirection
2. Query
    - Echo request or reply
        - ICMP echo request message is sent by a source host to query a router or destination host, which will respond with an ICMP echo reply message
        - This message contains data which is the same as the request message (if any data was present initially)
    - Timestamp request or reply

## PING

-   Ping (Packet InterNet Grouper) is a useful network debugging tool for testing the reachability of a host/router
-   Operates by sending/receiving ICMP echo messages

-   ICMP error messages are sent by a router or destination host to inform the source host that its datagram has been received in error, and is discarded
-   The data section of ICMP error message will contain part of the original IP datagram in error - the complete header and the first 8 bytes of the payload
    -   For example, ICMP port unreachable
    -   A client requests a service at a port 80
    -   However, at the server, no process is waiting at port 80
    -   Hence, returned a "port unreachable"
        -   Type = 0x03 (the type code for ICMP port unreachable error)
        -   Code = 0x03
        -   Checksum
        -   Unused = 0x00000000
        -   Data = Original datagram causing error (complete header + first 8 bytes)
    -   E.g. ICMP Time Exceeded
        -   In the IP header field, there is a "Time to Live" field
        -   It is a counter used to limit the IP datagram's lifetime, the number of hops the datagram can take
        -   The counter is initialised with an integer value up to 255
        -   When teh counter hits 0, the IP datagram is discarded

## TRACERT

-   Tracert is another useful network debugging tool for tracing a path from source to destination host
-   Operates by sending a sequence of ICMP echo requests over IP, with TTL set to 1, 2, ... until the destination is reached
-   Note: Tracert can also be implemented using UDP with unused port number (e.g. 33534) over IP

# Resources

-   https://www.cloudflare.com/learning/network-layer/what-is-a-subnet/
